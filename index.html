<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Exam Timer</title>
<style>
    body {
        background: black;
        color: white;
        font-family: "Helvetica", "Arial", sans-serif;
        margin: 0;
        padding: 0;
    }

    .container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 2rem;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 3rem;
        flex-grow: 1;
        align-items: start;
    }

    .timeline {
        position: relative;
        height: 80vh;
        width: 200px;
        margin: auto;
    }

    .marker {
        position: absolute;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        width: 100%;
    }

    .marker span {
        margin-right: 1rem;
        white-space: nowrap;
        font-size: 1.8rem;
    }

    .marker.check {
        color: #22c55e; /* green */
    }

    .clock {
        font-size: 6rem;
        font-weight: 800;
    }

    .exam-status {
        margin-top: 3rem;
        flex-grow: 1;
    }

    .exam-status h1 {
        font-size: 2.5rem;
        color: #facc15; /* yellow */
        margin-bottom: 0.5rem;
    }

    .exam-status h2 {
        font-size: 2rem;
        font-style: italic;
        margin-bottom: 0.5rem;
    }

    .finish-time {
        margin-top: 2rem;
        font-size: 2rem;
        font-style: italic;
    }

    .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        gap: 3rem;
        padding: 1.5rem;
    }

    .bottom-bar button {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        opacity: 0.3;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .bottom-bar button:hover {
        opacity: 0.6;
    }

</style>
</head>
<body>
<div class="container">
    <div class="grid">
        <!-- Timeline -->
        <div class="timeline" id="timeline"></div>

        <!-- Main content -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                <div class="clock" id="digitalClock">00:00</div>
                <div class="text-right" id="timeInfo" style="font-size:1.5rem"></div>
            </div>

            <div class="exam-status" id="examStatus"></div>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button id="startPauseBtn">Start</button>
    <button id="resetBtn">Reset</button>
    <button id="extraTimeBtn">Extra Time OFF</button>
    <button id="autoStartBtn">Auto-Start OFF</button>
</div>

<script>
/* =============================
   CONFIGURATION CONSTANTS
============================= */
const DEFAULT_DURATION_MINUTES = 180;
const TOTAL_DURATION_SECONDS = DEFAULT_DURATION_MINUTES * 60;
const WARNING_THRESHOLD_SECONDS = 15 * 60;
const INITIAL_RESTRICTION_SECONDS = 45 * 60;
const EXTRA_TIME_LIMIT_SECONDS = -30 * 60;

/* =============================
   STATE VARIABLES
============================= */
let timeRemainingSeconds = TOTAL_DURATION_SECONDS;
let isPaused = true;
let isFinished = false;
let isExtraTimeEnabled = false;
let isAutoStartEnabled = false;
let startTime = null;
let finishTime = null;
let autoStartTime = null;

let intervalId = null;
let autoCheckId = null;

/* =============================
   UTILITY FUNCTIONS
============================= */
function formatTimeHMM(totalSeconds) {
    const abs = Math.abs(totalSeconds);
    const h = Math.floor(abs / 3600);
    const m = Math.floor((abs % 3600) / 60);
    return `${h}:${String(m).padStart(2, "0")}`;
}

function formatTimeMMSS(totalSeconds) {
    const abs = Math.abs(totalSeconds);
    const m = Math.floor(abs / 60);
    const s = abs % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function calculateNextHalfHourTime() {
    const now = new Date();
    let next = new Date(now);
    const mins = now.getMinutes();
    if (mins < 30) next.setMinutes(30,0,0);
    else {
        next.setHours(now.getHours()+1);
        next.setMinutes(0,0,0);
    }
    return next;
}

/* =============================
   DIGITAL CLOCK
============================= */
function updateDigitalClock() {
    const now = new Date();
    const time = now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:false});
    document.getElementById("digitalClock").textContent = time;
}
setInterval(updateDigitalClock, 1000);

/* =============================
   MAIN TIMER FUNCTIONS
============================= */
function tick() {
    timeRemainingSeconds -= 1;
    const elapsed = TOTAL_DURATION_SECONDS - timeRemainingSeconds;

    if (!isExtraTimeEnabled && timeRemainingSeconds <= 0) {
        timeRemainingSeconds = 0;
        stopTimer();
        isFinished = true;
    }

    if (isExtraTimeEnabled && timeRemainingSeconds <= EXTRA_TIME_LIMIT_SECONDS) {
        timeRemainingSeconds = EXTRA_TIME_LIMIT_SECONDS;
        stopTimer();
        isFinished = true;
    }

    if (timeRemainingSeconds === 0 && !isFinished) {
        isFinished = true;
    }

    render();
}

function startTimer() {
    if (isPaused) {
        if (timeRemainingSeconds === TOTAL_DURATION_SECONDS) {
            startTime = new Date();
            finishTime = new Date(startTime.getTime() + TOTAL_DURATION_SECONDS * 1000);
        }
        intervalId = setInterval(tick, 1000);
        isPaused = false;
    }
}

function stopTimer() {
    clearInterval(intervalId);
    intervalId = null;
    isPaused = true;
}

function resetTimer() {
    stopTimer();
    clearInterval(autoCheckId);
    isPaused = true;
    isFinished = false;
    isExtraTimeEnabled = false;
    isAutoStartEnabled = false;
    timeRemainingSeconds = TOTAL_DURATION_SECONDS;
    startTime = null;
    finishTime = null;
    autoStartTime = null;
    render();
}

/* =============================
   AUTO-START LOGIC
============================= */
function enableAutoStart() {
    if (!isPaused || isFinished) return;
    isAutoStartEnabled = true;
    autoStartTime = calculateNextHalfHourTime();
    autoCheckId = setInterval(() => {
        const now = new Date();
        if (now >= autoStartTime) {
            disableAutoStart();
            startTimer();
            startTime = new Date();
            finishTime = new Date(startTime.getTime() + TOTAL_DURATION_SECONDS * 1000);
            render();
        }
    }, 1000);
}

function disableAutoStart() {
    isAutoStartEnabled = false;
    clearInterval(autoCheckId);
    autoCheckId = null;
}

/* =============================
   UI RENDERING
============================= */
function renderTimeline() {
    const container = document.getElementById("timeline");
    container.innerHTML = "";
    const intervalMins = 15;
    const elapsed = TOTAL_DURATION_SECONDS - timeRemainingSeconds;
    for (let min = 0; min <= DEFAULT_DURATION_MINUTES; min += intervalMins) {
        const top = (min / DEFAULT_DURATION_MINUTES) * 100;
        const markerSecs = min * 60;
        const label = (min === 0) ? "Start" : (min === DEFAULT_DURATION_MINUTES ? "Finish" : formatTimeHMM(markerSecs));
        const passed = markerSecs <= elapsed;
        const marker = document.createElement("div");
        marker.className = "marker" + (passed ? " check" : "");
        marker.style.top = top + "%";
        marker.innerHTML = `<span>${label}</span>${passed ? "âœ”" : ""}`;
        container.appendChild(marker);
    }
}

function renderStatus() {
    const el = document.getElementById("examStatus");
    const warn = (timeRemainingSeconds > 0 && timeRemainingSeconds <= WARNING_THRESHOLD_SECONDS);
    const elapsed = TOTAL_DURATION_SECONDS - timeRemainingSeconds;
    const restricted = (!isPaused && elapsed >= 0 && elapsed <= INITIAL_RESTRICTION_SECONDS);
    let html = "";

    if (isExtraTimeEnabled && timeRemainingSeconds <= EXTRA_TIME_LIMIT_SECONDS) {
        html = `<h1>The exam has ended.</h1>
                <h2>You must stop writing.</h2>
                <h2>Please remain silent as there may be other candidates still writing.</h2>
                <h2>Listen carefully to all exit instructions.</h2>
                <h2>You will be told when you can leave.</h2>`;
    }
    else if (isFinished && isExtraTimeEnabled && timeRemainingSeconds < 0) {
        html = `<h1>Extra Time is in progress.</h1>
                <h2 style="color:#f87171">(Extra Time: ${formatTimeMMSS(timeRemainingSeconds)})</h2>`;
    }
    else if (isFinished) {
        html = `<h1>The exam has ended.</h1>
                <h2>You must stop writing.</h2>
                <h2>Please remain silent as there may be other candidates still writing.</h2>
                <h2>Listen carefully to all exit instructions.</h2>
                <h2>You will be told when you can leave.</h2>`;
    }
    else if (isPaused && isAutoStartEnabled) {
        html = `<h1>Exam will auto-start at ${autoStartTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:false})}</h1>`;
    }
    else if (isPaused && elapsed < TOTAL_DURATION_SECONDS) {
        html = `<h1>The exam is paused. Please stop writing.</h1>
                <h2>You will be told when you can begin again.</h2>`;
    }
    else if (warn) {
        html = `<h1>You may not leave in the final 15 minutes of the exam.</h1>
                <h2>If you are finished, stay seated and wait for the exam to end.</h2>`;
    }
    else if (restricted) {
        html = `<h1>You may not leave in the first 45 minutes of the exam.</h1>
                <h2>Please stay in your seat. If you need a supervisor, raise your hand.</h2>`;
    }
    else {
        html = `<h1>Please remain seated at your desk at all times.</h1>
                <h2>If you need to visit the bathroom, raise your hand.</h2>
                <h2>If you are finished and would like to leave, raise your hand.</h2>`;
    }

    if (finishTime && !isFinished) {
        html += `<div class="finish-time">The exam will finish at ${finishTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:false})}</div>`;
    }

    el.innerHTML = html;
}

function renderInfo() {
    const info = document.getElementById("timeInfo");
    if (startTime && finishTime) {
        info.innerHTML = `
            <div>Start: ${startTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:false})}</div>
            <div>Finish: ${finishTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:false})}</div>`;
    } else {
        info.innerHTML = "";
    }
}

function render() {
    renderTimeline();
    renderStatus();
    renderInfo();

    document.getElementById("startPauseBtn").textContent = isPaused ? "Start" : "Pause";
    document.getElementById("extraTimeBtn").textContent = `Extra Time ${isExtraTimeEnabled ? "ON" : "OFF"}`;
    document.getElementById("autoStartBtn").textContent = `Auto-Start ${isAutoStartEnabled ? "ON" : "OFF"}`;
}

/* =============================
   EVENT LISTENERS
============================= */
document.getElementById("startPauseBtn").addEventListener("click", () => {
    if (isPaused) startTimer();
    else stopTimer();
    render();
});

document.getElementById("resetBtn").addEventListener("click", () => resetTimer());

document.getElementById("extraTimeBtn").addEventListener("click", () => {
    isExtraTimeEnabled = !isExtraTimeEnabled;
    render();
});

document.getElementById("autoStartBtn").addEventListener("click", () => {
    if (isAutoStartEnabled) disableAutoStart();
    else enableAutoStart();
    render();
});

/* Initial render */
render();

</script>
</body>
</html>
